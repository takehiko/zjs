<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html lang="ja">
<head>
<meta name="author" content="Takehiko Murakawa">
<meta name="copyright" content="(c) 2008-2010 Takehiko Murakawa">
<meta name="reply-to" content="takehiko@sys.wakayama-u.ac.jp">
<meta name="date" content="Fri, 20 Aug 2010 05:10:53 +0900">
<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>zjs</title>
<style type="text/css">
body {background-color:black;margin:0;position:relative}
input, select {font-size:100%}
#config table {background-color:#cc9; padding:1ex}
#readme {background-color:#c96; padding:1ex; font-size:small}
#keybind,#iv_keybind {background-color:#cc3; padding:1ex; font-size:small}
#log {background-color:#6c9; padding:1ex; font-size:small}
.minsecform {text-align:right}
#sand {z-index:1; display:none; position:absolute; left:0px; top:0px; width:100%; height:1px; background-color:black}
#disp {z-index:2; position:relative; padding:6px}
</style>
<script type="text/javascript">
var zjs = {};

zjs.config = {
    bell: new Array(
        { 
            "ring": 1,
            "etime": 5 * 1000,
            "wavtype": 1
        }, {
            "ring": 1,
            "etime": 10 * 1000,
            "wavtype": 1
        }, {
            "ring": 1,
            "etime": 15 * 1000,
            "wavtype": 2
        }, {
            "ring": 1,
            "etime": 20 * 1000,
            "wavtype": 3
        }),

    colorArray1: new Array(
        {
            "timeColor": "#0f0",
            "statusLabel": "Pause"
        }, {
            "timeColor": "#0f0",
            "statusLabel": "Talking"
        }, {
            "timeColor": "#6f0",
            "statusLabel": "Talking"
        }, {
            "timeColor": "#cf0",
            "statusLabel": "Talking"
        }, {
            "timeColor": "#ff0",
            "statusLabel": "Q&amp;A"
        }, {
            "timeColor": "#f33",
            "statusLabel": "Overrun! Q&amp;A"
        }, {
            "timeColor": "#f33",
            "statusLabel": "Overrun! Talking"
        }),

    colorArray2: new Array(
        {
            "timeColor": "#0f0",
            "statusLabel": "Pause"
        }, {
            "timeColor": "#0f0",
            "statusLabel": "Talking"
        }, {
            "timeColor": "#6f0",
            "statusLabel": "Talking"
        }, {
            "timeColor": "#cf0",
            "statusLabel": "Talking"
        }, {
            "timeColor": "#ff0",
            "statusLabel": "Q&amp;A"
        }, {
            "timeColor": "#f33",
            "statusLabel": "Overrun! Q&amp;A"
        }, {
            "timeColor": "#f33",
            "statusLabel": "Overrun! Talking"
        }),

    titleArray: new Array(
        "zjs: count-down mode while talking",
        "zjs: count-up mode",
        "zjs"
    ),

    debugMode: false,
    noKey: false,
    noMouseOnClock: true,
    noChangeTitle: false,

    bellWavArray: new Array(null, "chime1.wav", "chime2.wav", "chime3.wav"),
    noChangeBellWav: false,

    digitScale: 21,
    minsecLabelScale: 3,
    ringMode: null,
    userAgent: null,
    hourglassMode: 0,
    boardMagnifyMode: 2,
    boardMagnifyPercent: 120,
    longwiseMode: 0,
    _dummy_: null
};

(function () {
     var prop = zjs.config;

     function init() {
         setupUserAgent();
         setupByURI();

         if (prop.debugMode) {
             zjs.screen.changeStyle("debugmessage", "display", "block");
         }
         if (prop.noKey) {
             zjs.screen.keybindId = "iv_keybind";
             zjs.screen.changeStyle("readme_key", "display", "none");
         } else {
             document.onkeyup = zjs.key.eventKeyUp;
         }
         if (prop.noMouseOnClock) {
             document.getElementById("time").onclick = null;
         }

         zjs.bell.setupRing();
         zjs.screen.changeFontSize();
         zjs.clock.hold();
         zjs.screen.changeTimeColorLabel(zjs.screen.color.index);
         zjs.clock.resetClock();
         zjs.board.setForm();
         zjs.board.setMagnify();
     }

     function setupUserAgent() {
         if (prop.userAgent == null) {
             var ua = navigator.userAgent;

             if (ua.indexOf("Opera") >= 0) {
                 prop.userAgent = "opera";
             } else if (ua.indexOf("MSIE") >= 0) {
                 prop.userAgent = "msie";
             } else if (ua.indexOf("Firefox") >= 0) {
                 prop.userAgent = "firefox";
             } else if (ua.indexOf("Chrome") >= 0) {
                 prop.userAgent = "chrome";
             } else if (ua.indexOf("iPod") >= 0 || ua.indexOf("iPhone") >= 0 || ua.indexOf("iPad") >= 0) {
                 prop.userAgent = "ipod";
             } else if (ua.indexOf("Safari") >= 0) {
                 prop.userAgent = "safari";
             } else {
                 prop.userAgent = "other";
             }
         }

         if (prop.userAgent == "ipod") {
             prop.noKey = true;
             prop.noMouseOnClock = false;
             prop.noChangeTitle = true;
         }
     }

     function setupByURI() {
         var path = location.pathname;
         if (path.match(/\//)) {
             path = path.replace(/^.*\//, "");
         }
         path += location.search + location.hash;

         if (path.match(/p=?(\d+)([a-z]?)/)) {
             var num = myParseInt(RegExp.$1);
             var opt = RegExp.$2;
             if (num == 5) {
                 presetBell();
                 prop.bell[0].etime = (2 * 60 + 30) * 1000;
                 prop.bell[2].etime = 3 * 60 * 1000;
                 prop.bell[3].etime = 5 * 60 * 1000;
             } else if (num == 10) {
                 presetBell();
                 prop.bell[0].etime = 7 * 60 * 1000;
                 prop.bell[2].etime = 8 * 60 * 1000;
                 prop.bell[3].etime = 10 * 60 * 1000;
             } else if (num == 15) {
                 presetBell();
                 prop.bell[0].etime = 8 * 60 * 1000;
                 prop.bell[2].etime = 10 * 60 * 1000;
                 prop.bell[3].etime = 15 * 60 * 1000;
             } else if (num == 20) {
                 presetBell();
                 prop.bell[0].etime = 12 * 60 * 1000;
                 prop.bell[2].etime = 15 * 60 * 1000;
                 prop.bell[3].etime = 20 * 60 * 1000;
             } else if (num == 30) {
                 presetBell();
                 if (opt == "a") {
                     prop.bell[0].etime = 20 * 60 * 1000;
                     prop.bell[2].etime = 25 * 60 * 1000;
                     prop.bell[3].etime = 30 * 60 * 1000;
                 } else {
                     prop.bell[0].etime = 15 * 60 * 1000;
                     prop.bell[2].etime = 20 * 60 * 1000;
                     prop.bell[3].etime = 30 * 60 * 1000;
                 }
             }
         }

         if (path.match(/m=?(\d\d)(\d\d)(\d\d)(\d\d)/)) {
             setBellByStringMin(RegExp.$1, RegExp.$2, RegExp.$3, RegExp.$4);
         } else if (path.match(/m=?(\d*)[_\-, ](\d*)[_\-, ](\d*)[_\-, ](\d*)/)) {
             setBellByStringMin(RegExp.$1, RegExp.$2, RegExp.$3, RegExp.$4);
         } else if (path.match(/m=?(\d\d)(\d\d)(\d\d)/)) {
             setBellByStringMin(RegExp.$1, "0", RegExp.$2, RegExp.$3);
         } else if (path.match(/m=?(\d*)[_\-, ](\d*)[_\-, ](\d*)/)) {
             setBellByStringMin(RegExp.$1, "0", RegExp.$2, RegExp.$3);
         }

         if (path.match(/s=?(\d\d\d\d)(\d\d\d\d)(\d\d\d\d)(\d\d\d\d)/)) {
             setBellByStringSec(RegExp.$1, RegExp.$2, RegExp.$3, RegExp.$4);
         } else if (path.match(/s=?(\d*)[_\-, ](\d*)[_\-, ](\d*)[_\-, ](\d*)/)) {
             setBellByStringSec(RegExp.$1, RegExp.$2, RegExp.$3, RegExp.$4);
         } else if (path.match(/s=?(\d\d\d\d)(\d\d\d\d)(\d\d\d\d)/)) {
             setBellByStringSec(RegExp.$1, "0", RegExp.$2, RegExp.$3);
         } else if (path.match(/s=?(\d*)[_\-, ](\d*)[_\-, ](\d*)/)) {
             setBellByStringSec(RegExp.$1, "0", RegExp.$2, RegExp.$3);
         }

         if (path.match(/w=?(\d+)/)) {
             prop.ringMode = myParseInt(RegExp.$1);
         }
         if (prop.ringMode == null) {
             if (prop.userAgent == "chrome") {
                 prop.ringMode = 2;
             } else if (typeof(Audio) != "undefined") {
                 prop.ringMode = 3;
             } else {
                 prop.ringMode = 2;
             }
         }

         if (path.match(/h=?(\d+)/)) {
             prop.hourglassMode = myParseInt(RegExp.$1);
         }

         if (path.match(/mg=?(\d+)/)) {
             prop.boardMagnifyMode = myParseInt(RegExp.$1);
         }
         if (path.match(/mp=?(\d+)/)) {
             prop.boardMagnifyPercent = myParseInt(RegExp.$1);
         }

         if (!prop.noChangeBellWav) {
             var bellWavDir = "";
             var bellWavBase = "chime";

             if (path.match(/d=([A-Za-z0-9\-\/_]+)/)) {
                 bellWavDir = RegExp.$1;
                 if (!bellWavDir.match(/\/$/)) {
                     bellWavDir += "/";
                 }
             }
             if (path.match(/b=([A-Za-z0-9\-_]+)/)) {
                 bellWavBase = RegExp.$1;
             }
             for (var i = 1; i <= 3; i++) {
                 prop.bellWavArray[i] = bellWavDir + bellWavBase + i + ".wav";
             }
         }

         if (path.match(/nokey/i)) {
             prop.noKey = true;
         } else if (path.match(/key/i)) {
             prop.noKey = false;
         }
         if (path.match(/nomouse/i)) {
             prop.noMouseOnClock = true;
         } else if (path.match(/mouse/i)) {
             prop.noMouseOnClock = false;
         }
         if (path.match(/nodebug/i)) {
             prop.debugMode = false;
         } else if (path.match(/debug/i)) {
             prop.debugMode = true;
         }
     }

     function presetBell() {
         prop.bell[0].ring = 1;
         prop.bell[0].wavtime = 1;
         prop.bell[1].ring = 0;
         prop.bell[2].ring = 1;
         prop.bell[2].wavtime = 2;
         prop.bell[3].ring = 1;
         prop.bell[3].wavtime = 3;
     }

     function setBellByStringMin(min1, min2, min3, min4) {
         var secArray = new Array(myParseInt(min1) * 60,
                                  myParseInt(min2) * 60,
                                  myParseInt(min3) * 60,
                                  myParseInt(min4) * 60);
         setBellByArray(secArray);
     }

     function setBellByStringSec(sec1, sec2, sec3, sec4) {
         var secArray = new Array(myParseInt(sec1),
                                  myParseInt(sec2),
                                  myParseInt(sec3),
                                  myParseInt(sec4));
         setBellByArray(secArray);
     }

     function setBellByArray(secArray) {
         for (var i = 0; i < 4; i++) {
             prop.bell[i].etime = secArray[i] * 1000;
             if (secArray[i] == 0) {
                 prop.bell[i].ring = 0;
             } else {
                 prop.bell[i].ring = 1;
             }
         }
     }

     function myParseInt(value) {
         if (value == null) {
             return 0;
         }
         value = value.replace(/^0+/, "");
         if (value == "") {
             return 0;
         }
         return parseInt(value);
     }

     zjs.config.init = init;
     zjs.config.myParseInt = myParseInt;
})();

zjs.clock = {
    clockTick: false,
    etime1: 0,
    etime2: 0,
    etimeLastMark: 0,
    timeStart: 0,
    countMark: 0,
    _dummy_: null
};

(function () {
     var prop = zjs.clock;
     var myInterval = null;

     function startClock() {
         if (!prop.clockTick) {
             if (prop.etime1 == 0) {
                 zjs.board.appendToLog("start", true);
             }

             myInterval = setInterval("zjs.screen.updateClock()", 100);
             prop.timeStart = (new Date()).getTime();
             tick();
             zjs.screen.changeStyle("buttonstart", "display", "none");
             zjs.screen.changeStyle("buttonstop", "display", "inline");
             zjs.screen.changeStyle("buttonreset", "display", "none");
         }
     }

     function stopClock() {
         if (prop.clockTick) {
             hold();
             if (myInterval != null) {
                 clearInterval(myInterval);
                 myInterval = null;
             }
             zjs.screen.updateClock();
             prop.etime1 = prop.etime1 + prop.etime2;
             prop.etime2 = 0;

             document.getElementById("buttonstart").value = "Resume";
             zjs.screen.changeStyle("buttonstart", "display", "inline");
             zjs.screen.changeStyle("buttonstop", "display", "none");
             zjs.screen.changeStyle("buttonreset", "display", "inline");
             zjs.screen.changeStyle("timeminlabel", "visibility", "visible");

             if (zjs.config.debugMode) {
                 document.getElementById("debugmessage").innerHTML = "etime1:" + prop.etime1 + ", etime2:" + prop.etime2;
             }
         }
     }

     function toggleClock() {
         if (prop.clockTick) {
             stopClock();
             if (prop.countMark > 0) {
                 prop.markLapTime();
             }
         } else {
             startClock();
         }
     }

     function resetClock() {
         if (!prop.clockTick) {
             for (var i = 0; i <= 3; i++) {
                 if (zjs.bell.bellArray[i].ring == 2) {
                     zjs.bell.bellArray[i].ring = 1;
                 }
             }
             prop.etime1 = 0;
             prop.etime2 = 0;
             prop.etimeLastMark = 0;
             prop.countMark = 0;
             zjs.screen.displayTime(0);

             if (zjs.screen.color.index == 0) {
                 zjs.screen.changeTimeColorLabel(2);
             }

             zjs.screen.updateTitle();
             document.getElementById("buttonstart").value = "Start";
             zjs.screen.changeStyle("buttonstart", "display", "inline");
             zjs.screen.changeStyle("buttonstop", "display", "none");
             zjs.screen.changeStyle("buttonreset", "display", "inline");
             zjs.screen.movePageTop();

             zjs.board.appendToLog("reset", true);
         }
     }

     function timeToString(time) {
         var str = "";
         var hour, min, sec, msec;

         msec = time % 1000; time = (time - msec) / 1000;
         sec = time % 60; time = (time - sec) / 60;
         min = time % 60; time = (time - min) / 60;
         hour = time;

         if (hour > 0) {
             str += "" + hour + " hour ";
         }
         if (hour + min > 0) {
             str += "" + (hour > 0 && min < 10 ? "0" : "") + min + " min ";
         }
         str += "" + (hour + min > 0 && sec < 10 ? "0" : "") + sec + " sec ";
         str += "<span style=\"font-size:75%\">" + (msec < 100 ? "0" : "") + (msec < 10 ? "0" : "") + msec + "</span>";

         return str;
     }

     function markTime(paren) {
         var etime = getElapsedTime();
         var laptime = etime - prop.etimeLastMark;
         prop.etimeLastMark = etime;
         prop.countMark++;

         zjs.board.appendToLog((paren == 0 ? "&lt;" : "[") + prop.countMark + (paren == 0 ? "&gt; " : "] ") + timeToString(etime) + " (+" + timeToString(laptime) + ")", false);
     }

     function markLapTime(paren) {
         var etime = getElapsedTime();
         var laptime = etime - prop.etimeLastMark;

         zjs.board.appendToLog("[Pause] " + timeToString(etime) + " (+" + timeToString(laptime) + ")", false);
     }

     function getElapsedTime() {
         if (prop.clockTick) {
             var timeStop = (new Date()).getTime();
             prop.etime2 = timeStop - prop.timeStart;
         }
         return prop.etime1 + prop.etime2;
     }

     function hold() {
         prop.clockTick = false;
         zjs.screen.setLongwise();
         zjs.screen.changeStyle("config", "display", "block");
     }

     function tick() {
         prop.clockTick = true;
         zjs.screen.changeStyle("config", "display", "none");
         zjs.screen.setLongwise();
     }

     zjs.clock.startClock = startClock;
     zjs.clock.stopClock = stopClock;
     zjs.clock.toggleClock = toggleClock;
     zjs.clock.resetClock = resetClock;
     zjs.clock.markTime = markTime;
     zjs.clock.markLapTime = markLapTime;
     zjs.clock.getElapsedTime = getElapsedTime;
     zjs.clock.hold = hold;
     zjs.clock.tick = tick;
})();

zjs.key = {
    timeTypeEsc: null,
    timeTypeRing: null,
    typeRing: 0,
    _dummy_: null
};

(function () {
     var prop = zjs.key;

     function eventKeyUp(e) {
         var code = 0;

         if (zjs.board.focusingText) {
             return;
         }

         if (document.all) {
             code = event.keyCode;
         } else if (document.getElementById) {
             code = e.keyCode ? e.keyCode : e.charCode;
         } else if(document.layers) {
             code = e.which;
         }

         if (code == 32 || code == 90 || code == 53) {
             zjs.clock.toggleClock();
         } else if (code == 27 || code == 88 || code == 48) {
             if (!zjs.clock.clockTick) {
                 var t = (new Date()).getTime();
                 if (prop.timeTypeEsc != null && t - prop.timeTypeEsc <= 1000) {
                     zjs.clock.resetClock();
                     prop.timeTypeEsc = null;
                 } else {
                     prop.timeTypeEsc = t;
                 }
             }
         } else if (code == 65 || code == 83 || code == 68) {
             if (zjs.config.ringMode != 0) {
                 var t = (new Date()).getTime();
                 if (prop.timeTypeRing != null && t - prop.timeTypeRing <= 1000 && prop.typeRing == code) {
                     prop.timeTypeRing = t;
                     prop.typeRing = code;
                     if (code == 65) {
                         zjs.bell.ring(1);
                     } else if (code == 83) {
                         zjs.bell.ring(2);
                     } else {
                         zjs.bell.ring(3);
                     }
                 } else {
                     prop.timeTypeRing = t;
                     prop.typeRing = code;
                 }
             }
         } else if (code == 72 || code == 57) {
             if (!zjs.clock.clockTick) {
                 zjs.board.displayReadme();
             }
         } else if (code == 46 || code == 190 || code == 50) {
             if (zjs.clock.clockTick) {
                 zjs.clock.markTime();
                 zjs.screen.updateTitle();
             } else {
                 zjs.board.displayLog();
             }
         } else if (code == 80 || code == 56) {
             zjs.screen.toggleTimeColorLabel();
         } else if (code == 75 || code == 55) {
             if (!zjs.clock.clockTick) {
                 zjs.board.displayKeybind();
             }
         } else if (code == 71) {
             zjs.config.hourglassMode = (zjs.config.hourglassMode + 1) % 3;
             zjs.screen.updateClock();
         } else if (code == 77 || code == 51) {
             zjs.config.digitScale++;
             zjs.screen.changeFontSize();
             zjs.screen.updateClock();
         } else if (code == 78 || code == 49) {
             if (zjs.config.digitScale > 1) {
                 zjs.config.digitScale--;
                 zjs.screen.changeFontSize();
                 zjs.screen.updateClock();
             }
         } else if (code == 66) {
             if (!zjs.clock.clockTick && zjs.config.boardMagnifyMode != 0) {
                 zjs.board.nextMagnify();
             }
         }
     }

     zjs.key.eventKeyUp = eventKeyUp;
})();

zjs.board = {
    readmeToggle: false,
    logMessage: "",
    logToggle: false,
    focusingText: false,
    keybindToggle: false,
    _dummy_: null
};

(function () {
     var prop = zjs.board;

     function appendToLog(message, flag) {
         if (flag) {
             message += " (" + (new Date()).toLocaleString() + ")";
         }
         prop.logMessage += message + "<br>\n";
         document.getElementById("log").innerHTML = prop.logMessage;
     }

     function chopFirstBell1() {
         var obj = document.getElementById("cfglabel0");
         var label = obj.innerHTML;
         if (label.match(/1$/)) {
             obj.innerHTML = label.replace(/1$/, "");
         }
     }

     function setForm() {
         for (var i = 0; i <= 3; i++) {
             var min, sec;
             var minsec;

             switch (i) {
             case 0:
             case 1:
                 minsec = zjs.bell.bellArray[2].etime - zjs.bell.bellArray[i].etime;
                 break;
             case 2:
                 minsec = zjs.bell.bellArray[2].etime;
                 break;
             case 3:
                 minsec = zjs.bell.bellArray[i].etime - zjs.bell.bellArray[2].etime;
                 break;
             }
             if (minsec < 0) {
                 min = sec = 0;
             } else {
                 minsec = Math.floor(minsec / 1000);
                 min = Math.floor(minsec / 60);
                 sec = minsec % 60;
             }
             document.getElementById("cfgmin" + i).value = "" + min;
             document.getElementById("cfgsec" + i).value = "" + sec;

             var wavtype = (zjs.bell.bellArray[i].ring == 0) ? 0 : zjs.bell.bellArray[i].wavtype;
             document.getElementById("cfgwav" + i).value = "" + wavtype;
         }
     }

     function getForm() {
         var minsecArray = new Array();
         for (var i = 0; i <= 3; i++) {
             var min = zjs.config.myParseInt(document.getElementById("cfgmin" + i).value);
             var sec = zjs.config.myParseInt(document.getElementById("cfgsec" + i).value);
             minsecArray[i] = min * 60 + sec;

             var wavtype = zjs.config.myParseInt(document.getElementById("cfgwav" + i).value);
             zjs.bell.bellArray[i].wavtype = wavtype;
             zjs.bell.bellArray[i].ring = (wavtype == 0 ? 0 : 1);
         }

         zjs.bell.bellArray[0].etime = (minsecArray[2] - minsecArray[0]) * 1000;
         zjs.bell.bellArray[1].etime = (minsecArray[2] - minsecArray[1]) * 1000;
         zjs.bell.bellArray[2].etime = minsecArray[2] * 1000;
         zjs.bell.bellArray[3].etime = (minsecArray[2] + minsecArray[3]) * 1000;
         if (zjs.bell.bellArray[3].ring == 0) {
             zjs.bell.bellArray[3].etime = zjs.bell.bellArray[2].etime;
         }
     }

     function displayReadme() {
         prop.readmeToggle = !prop.readmeToggle;
         zjs.screen.changeStyle("readme", "display", prop.readmeToggle ? "block" : "none");
         if (prop.readmeToggle) {
             zjs.screen.movePageEnd();
         }
     }

     function displayKeybind() {
         prop.keybindToggle = !prop.keybindToggle;
         zjs.screen.changeStyle(zjs.screen.keybindId, "display", prop.keybindToggle ? "block" : "none");
         if (prop.keybindToggle) {
             zjs.screen.movePageEnd();
         }
     }

     function displayLog() {
         prop.logToggle = !prop.logToggle;
         zjs.screen.changeStyle("log", "display", prop.logToggle ? "block" : "none");
         if (prop.logToggle) {
             zjs.screen.movePageEnd();
         }
     }

     function showAdvice() {
         alert(document.getElementById("advice").innerHTML);
     }

     function fT(e) {
         prop.focusingText = true;
     }

     function bT(e) {
         prop.focusingText = false;
     }

     function setMagnify(percent) {
         if (percent) {
             zjs.config.boardMagnifyPercent = percent;
         } else if (zjs.config.boardMagnifyMode == 0) {
             zjs.screen.changeStyle("keybind_magnify", "display", "none");
             return;
         }
         var idArray = (zjs.config.boardMagnifyMode == 2) ?
             new Array("button", "config_table", "readme", "keybind", "log") :
             new Array("button", "config_table");
         for (var i in idArray) {
             zjs.screen.changeStyle(idArray[i], "fontSize", "" + zjs.config.boardMagnifyPercent + "%");
         }
     }

     function nextMagnify() {
         var p = zjs.config.boardMagnifyPercent;

         switch (p) {
         case 100:
             p = 120; break;
         case 120:
             p = 150; break;
         case 150:
             p = 200; break;
         case 200:
             p = 100; break;
         default:
             p = 100; break;
         }
         setMagnify(p);
     }

     zjs.board.appendToLog = appendToLog;
     zjs.board.chopFirstBell1 = chopFirstBell1;
     zjs.board.setForm = setForm;
     zjs.board.getForm = getForm;
     zjs.board.displayReadme = displayReadme;
     zjs.board.displayKeybind = displayKeybind;
     zjs.board.displayLog = displayLog;
     zjs.board.showAdvice = showAdvice;
     zjs.board.fT = fT;
     zjs.board.bT = bT;
     zjs.board.setMagnify = setMagnify;
     zjs.board.nextMagnify = nextMagnify;
})();

zjs.bell = {
    audioArray: new Array(null, null, null, null),
    bellArray: null,
    bellWavArray: null,
    ringMode: null,
    _dummy_: null
};

(function () {
     var prop = zjs.bell;

     function setupRing() {
         prop.bellArray = zjs.config.bell;
         prop.bellWavArray = zjs.config.bellWavArray;
         prop.ringMode = zjs.config.ringMode;
         delete zjs.config.bell;
         delete zjs.config.bellWavArray;
         delete zjs.config.ringMode;

         switch (prop.ringMode) {
         case 0:
             zjs.screen.changeStyle("readmering", "display", "none");
             zjs.screen.changeStyle("iv_readmering", "display", "list-item");
             zjs.screen.changeStyle("belltest", "display", "none");
             for (var i = 0; i <= 3; i++) {
                 zjs.screen.changeStyle("bellsort" + i, "display", "none");
             }
             break;
         case 2:
             var code = "";
             for (var i = 1; i <= 3; i++) {
                 code += "<embed id=\"sound" + i + "\" type=\"audio/wav\" src=\"" + prop.bellWavArray[i] + "\" autostart=\"false\" width=\"0\" height=\"0\" enablejavascript=\"true\">";
             }
             document.getElementById("sound").innerHTML = code;
             break;
         case 3:
             for (var i = 1; i <= 3; i++) {
                 prop.audioArray[i] = new Audio(prop.bellWavArray[i]);
             }
             break;
         default:
             break;
         }

         for (var i = 0; i <= 3; i++) {
             if (prop.bellArray[i].ring == 0) {
                 zjs.screen.changeStyle("timetr" + i, "display", "none");
             }
         }
         if (prop.bellArray[0].ring != 0 && prop.bellArray[1].ring == 0) {
             zjs.board.chopFirstBell1();
         }
     }

     function ring(wavid) {
         if (wavid != null && wavid > 0) {
             switch (prop.ringMode) {
             case 1:
                 document.getElementById("sound").innerHTML = "<embed id=\"embedsound\" type=\"audio/wav\" src=\"" + prop.bellWavArray[wavid] + "\" autostart=\"true\" hidden=\"true\" width=\"1\" height=\"1\">";
                 break;
             case 2:
                 document.getElementById("sound" + wavid).Play();
                 break;
             case 3:
                 prop.audioArray[wavid].play();
                 break;
             default:
                 break;
             }
         }
     }

     zjs.bell.setupRing = setupRing;
     zjs.bell.ring = ring;
})();

zjs.screen = {
    color: {
        base: null,
        index: 2,
        array: null
    },
    timeColor: null,
    statusLabel: null,
    scrWidth: 0,
    scrHeight: 0,
    hg: {
        ratio: 0,
        color: "#ffc"
    },
    keybindId: "keybind",
    _dummy_: null
};

(function () {
     var prop = zjs.screen;

     prop.color.base = new Array(zjs.config.colorArray1, zjs.config.colorArray2, zjs.config.colorArray1);
     prop.color.index = 2;
     prop.color.array = prop.color.base[prop.color.index];
     prop.timeColor = prop.color.array[0].timeColor;
     prop.statusLabel = prop.color.array[0].statusLabel;

     function changeStyle(id, style, value) {
         var obj = document.getElementById(id);
         if (obj) {
             obj.style[style] = value;
         }
     }

     function setTimeColor() {
         var colorStatus;

         if (zjs.bell.bellArray[3].ring == 2) {
             colorStatus = 5;
         } else if (zjs.bell.bellArray[2].ring == 2) {
             colorStatus = 4;
         } else if (zjs.bell.bellArray[1].ring == 2) {
             colorStatus = 3;
         } else if (zjs.bell.bellArray[0].ring == 2) {
             colorStatus = 2;
         } else if (zjs.clock.etime1 + zjs.clock.etime2 > 0) {
             colorStatus = 1;
         } else {
             colorStatus = 0;
         }
         if (colorStatus >= 4 && (zjs.bell.bellArray[3].ring == 0 || zjs.bell.bellArray[2].etime == zjs.bell.bellArray[3].etime)) {
             colorStatus = 6;
         }

         prop.timeColor = prop.color.array[colorStatus].timeColor;
         prop.statusLabel = prop.color.array[colorStatus].statusLabel;
         if (colorStatus != 0 && !zjs.clock.clockTick) {
             prop.statusLabel = prop.color.array[0].statusLabel;
         }

         changeStyle("time", "color", prop.timeColor);
         document.getElementById("timestatus").innerHTML = prop.statusLabel;
         changeStyle("timestatus", "color", prop.timeColor);
     }

     function displayTime(etime) {
         var dtime;

         if (prop.color.index == 1) {
             dtime = etime;
         } else if (etime <= zjs.bell.bellArray[2].etime) {
             dtime = zjs.bell.bellArray[2].etime - etime;
         } else {
             dtime = etime - zjs.bell.bellArray[2].etime;
         }
         var esec = Math.floor(dtime / 1000);
         var emin = Math.floor(esec / 60);
         esec = esec % 60;

         var eminStr = (emin < 10 ? "0" : "") + emin;
         var esecStr = (esec < 10 ? "0" : "") + esec;
         document.getElementById("timemin").innerHTML = eminStr;
         document.getElementById("timesec").innerHTML = esecStr;
         setTimeColor();

         if (etime <= zjs.bell.bellArray[2].etime) {
             prop.hg.ratio = etime / zjs.bell.bellArray[2].etime;
             prop.hg.color = "#026";
         } else if (etime <= zjs.bell.bellArray[3].etime) {
             prop.hg.ratio = 1 - (zjs.bell.bellArray[3].etime - etime) / (zjs.bell.bellArray[3].etime - zjs.bell.bellArray[2].etime);
             prop.hg.color = "#310";
         } else {
             prop.hg.ratio = 1;
             prop.hg.color = "#320";
         }
         refreshHourglass();

         if (zjs.clock.clockTick && etime % 1000 >= 600) {
             changeStyle("timeminlabel", "visibility", "hidden");
         } else {
             changeStyle("timeminlabel", "visibility", "visible");
         }
     }

     function resize() {
         if (zjs.config.hourglassMode != 0) {
             updateClock();
         }
         changeFontSize();
         setLongwise();
     }

     function setLongwise() {
         if (zjs.config.longwiseMode == 0) {
             return;
         }

         var pad = 0;
         if (zjs.clock.clockTick) {
             pad = document.body.clientHeight - document.getElementById("time").offsetHeight - 2 * document.getElementById("timestatus").offsetHeight;
             pad /= 2;
         }
         changeStyle("time", "paddingTop", "" + pad);
     }

     function refreshHourglass() {
         if (zjs.config.hourglassMode == 2 || (zjs.config.hourglassMode == 1 && zjs.clock.clockTick)) {
             var h = (1 - prop.hg.ratio) * document.body.clientHeight;
             changeStyle("body", "backgroundColor", prop.hg.color);
             changeStyle("sand", "height", "" + h + "px");
             changeStyle("sand", "display", "block");
             if (zjs.config.debugMode) {
                 document.getElementById("debugmessage").innerHTML += ", h=" + h + ", zjs.screen.hg.ratio=" + prop.hg.ratio + ", zjs.screen.hg.color=" + prop.hg.color;
             }
         } else {
             changeStyle("body", "backgroundColor", "black");
             changeStyle("sand", "display", "none");
         }
     }

     function changeFontSize() {
         prop.scrWidth = document.body.clientWidth;
         prop.scrHeight = document.body.clientHeight;

         if (zjs.config.debugMode) {
             document.getElementById("debugmessage").innerHTML = "test: width=" + prop.scrWidth + ", height=" + prop.scrHeight;
         }

         if (zjs.config.digitScale > 0) {
             var fs = prop.scrWidth * zjs.config.digitScale * 0.01;
             changeStyle("timemin", "fontSize", "" + fs + "pt");
             changeStyle("timesec", "fontSize", "" + fs + "pt");
         }

         if (zjs.config.minsecLabelScale > 0) {
             var fs = prop.scrWidth * zjs.config.minsecLabelScale * 0.01;
             changeStyle("timeminlabel", "fontSize", "" + fs + "pt");
             changeStyle("timeseclabel", "fontSize", "" + fs + "pt");
             changeStyle("timestatus", "fontSize", "" + fs + "pt");
         }

         setLongwise();
     }

     function changeTimeColorLabel(index) {
         prop.color.index = index;
         prop.color.array = prop.color.base[prop.color.index];
         updateTitle();
         setTimeColor();
         updateClock();
     }

     function updateTitle() {
         if (!zjs.config.noChangeTitle) {
             var title = zjs.config.titleArray[prop.color.index];
             if (zjs.clock.countMark > 0) {
                 title = "<" + zjs.clock.countMark + "> " + title;
             }
             document.title = title;
         }
     }

     function toggleTimeColorLabel() {
         changeTimeColorLabel((prop.color.index + 1) % 2);
     }

     function updateClock() {
         var etime = zjs.clock.getElapsedTime();

         if (zjs.config.debugMode) {
             document.getElementById("debugmessage").innerHTML = "etime=" + etime + ", etime1=" + zjs.clock.etime1 + ", etime2=" + zjs.clock.etime2;
         }

         displayTime(etime);

         for (var i = 0; i <= 3; i++) {
             if (zjs.bell.bellArray[i].ring == 1 && etime >= zjs.bell.bellArray[i].etime) {
                 zjs.bell.bellArray[i].ring = 2;
                 setTimeColor();
                 if (zjs.bell.bellArray[i].wavtype > 0) {
                     zjs.bell.ring(zjs.bell.bellArray[i].wavtype);
                 }
             }
         }
     }

     function movePageTop() {
         window.scrollTo(0, 0);
     }

     function movePageEnd() {
         window.scrollTo(0, document.documentElement.scrollHeight);
     }

     zjs.screen.changeStyle = changeStyle;
     zjs.screen.displayTime = displayTime;
     zjs.screen.resize = resize;
     zjs.screen.setLongwise = setLongwise;
     zjs.screen.changeFontSize = changeFontSize;
     zjs.screen.changeTimeColorLabel = changeTimeColorLabel;
     zjs.screen.updateTitle = updateTitle;
     zjs.screen.toggleTimeColorLabel = toggleTimeColorLabel;
     zjs.screen.updateClock = updateClock;
     zjs.screen.movePageTop = movePageTop;
     zjs.screen.movePageEnd = movePageEnd;
})();
</script>
</head>
<body id="body" onload="zjs.config.init()" onresize="zjs.screen.resize()">
<div id="sand"></div>
<div id="disp">
<div id="debugmessage" style="color:#ff6;font-weight:bold;display:none"></div>
<div id="timestatus" style="color:#ff6;font-weight:bold" ondblclick="zjs.clock.resetClock()">Pause</div>
<div id="time" style="color:#0f0;font-weight:bold;text-align:center" onclick="zjs.clock.toggleClock()">
<span id="timemin" style="font-size:200pt">03</span><span id="timeminlabel">min</span><span id="timesec" style="font-size:200pt">00</span><span id="timeseclabel">sec</span>
</div>
<div id="button">
<input id="buttonstart" type="button" value="Start" onclick="zjs.clock.startClock()" style="display:inline"><input id="buttonstop" type="button" value="Stop" onclick="zjs.clock.stopClock()" style="display:none"><input id="buttonreset" type="button" value="Reset" onclick="zjs.clock.resetClock()" style="display:inline">
</div>
<div id="config">
<table border="0" id="config_table">
<tr id="timetr2">
<th>Talk time</th>
    <td></td>
    <td>
<input id="cfgmin2" class="minsecform" type="text" value="15" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>min</span><input id="cfgsec2" class="minsecform" type="text" value="0" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>sec</span>
</td>
    <td id="bellsort2">
<span>/ Bell</span> <select id="cfgwav2"><option value="0">None</option>
<option value="1">1</option>
<option value="2" selected>2</option>
<option value="3">3</option></select>
</td>
  </tr>
<tr id="timetr0">
<th id="cfglabel0">Prior bell 1</th>
    <td></td>
    <td>
<input id="cfgmin0" class="minsecform" type="text" value="3" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>min</span><input id="cfgsec0" class="minsecform" type="text" value="0" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>sec <span style="font-size:75%">before finishing talk</span></span>
</td>
    <td id="bellsort0">
<span>/ Bell</span> <select id="cfgwav0"><option value="0">None</option>
<option value="1" selected>1</option>
<option value="2">2</option>
<option value="3">3</option></select>
</td>
  </tr>
<tr id="timetr1">
<th>Prior bell 2</th>
    <td></td>
<td>
<input id="cfgmin1" class="minsecform" type="text" value="0" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>min</span><input id="cfgsec1" class="minsecform" type="text" value="0" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>sec <span style="font-size:75%">before finishing talk</span></span>
</td>
    <td id="bellsort1">
<span>/ Bell</span> <select id="cfgwav1"><option value="0" selected>None</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3">3</option></select>
</td>
  </tr>
<tr id="timetr3">
<th>Q&amp;A time</th>
    <td></td>
    <td>
<input id="cfgmin3" class="minsecform" type="text" value="5" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>min</span><input id="cfgsec3" class="minsecform" type="text" value="0" size="6" onfocus="zjs.board.fT(this)" onblur="zjs.board.bT(this)"><span>sec</span>
</td>
    <td id="bellsort3">
<span>/ Bell</span> <select id="cfgwav3"><option value="0">None</option>
<option value="1">1</option>
<option value="2">2</option>
<option value="3" selected>3</option></select>
</td>
  </tr>
<tr>
<td colspan="4">
      <input type="button" value="Set form" onclick="zjs.board.getForm();zjs.clock.resetClock()"><input type="button" value="Revert form" onclick="zjs.board.setForm()"><input type="button" value="Change count-up/down" onclick="zjs.screen.toggleTimeColorLabel()"><input type="button" value="Ready?" onclick="zjs.board.showAdvice()" style="background-color:#9cf">
</td>
  </tr>
<tr>
<td colspan="4">
      <input type="button" value="Read me first" onclick="zjs.board.displayReadme()"><input type="button" value="Shortcut keys" onclick="zjs.board.displayKeybind()"><input type="button" value="Log" onclick="zjs.board.displayLog()">
</td>
  </tr>
<tr id="belltest">
<td colspan="4">
      <input type="button" value="Bell 1" onclick="zjs.bell.ring(1)"><input type="button" value="Bell 2" onclick="zjs.bell.ring(2)"><input type="button" value="Bell 3" onclick="zjs.bell.ring(3)">
</td>
  </tr>
</table>
<div id="readme" style="display:none"><ul>
<li>This is for managing the presenter's time on the second time scale. It is expected to be used in academic meetings or thesis defenses.</li>
  <li id="readme_key">You can use this timer not only by mouse but also by keyboard. It is ready for a numerical-keypad operation, too, but pay attention to Num Lock.</li>
  <li>When you push the "Reset" button above the control panel, the elapsed time is brought back to zero. If you would like to reflect your entries of the form, push the "Set form" button on the board. These operations are permitted only under suspension.</li>
  <li id="readmering">The HTML file itself works. But you can play the sounds or give the bell a ring if you have wav files.</li>
  <li id="iv_readmering" style="display:none">The HTML file itself works. But you can play the sounds or give the bell a ring, if you have wav files and change "ringMode: 0," of this file into "ringMode: null,".</li>
  <li>The initial character of "zjs" was named after "Zacho No Tomo" ("Chairperson's Companion", forcibly translated into English), a Windows application created by Mr. Tomohiko Imachi. I implemented the features of Zacho No Tomo by JavaScript at first, and have set in various useful functions from my own standpoint to be a comprehensive clock register.</li>
  <li>The latest and old versions of this file are available through <a href="http://github.com/takehiko/zjs/">GitHub</a>.</li>
</ul></div>
<!-- id="readme" -->
<div id="keybind" style="display:none">
[5] [Z] [SPC]: Start, stop, or resume the clock.<br>
[0] [X] [Esc]: Reset the clock (by double-hit in pausing).<br>
[A],[S],[D]: Ring the bell (by double-hit).<br>
[1] [N]: Shorten the clock display.<br>
[3] [M]: Enlarge the clock display.<br>
[7] [K]: Turn on/off the shortcut instruction.<br>
[8] [P]: Change the count-up/down mode.<br>
[9] [H]: Turn on/off the readme.<br>
[2] [.]: Turn on/off the log (in pausing). Record the clock time (in counting). Use it at rehearsal.<br><span id="keybind_magnify">[B]: Change the size of buttons and some components (in pausing).<br></span>
[G]: Change the hourglass mode.
</div>
<div id="iv_keybind" style="display:none">Keyboard operations are disabled.</div>
<div id="log" style="display:none"></div>
</div>
<!-- id="config" -->
<div id="sound"></div>
</div>
<div id="advice" style="display:none">Please make sure the screen is not black or
a screen-saver does not start
after you do nothing for a number of minutes.</div>
</body>
</html>
